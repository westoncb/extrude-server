(this["webpackJsonpextrude-client"]=this["webpackJsonpextrude-client"]||[]).push([[0],{148:function(e,t,a){e.exports=a(222)},152:function(e,t,a){},182:function(e,t){},191:function(e,t,a){},192:function(e,t,a){},219:function(e,t,a){},220:function(e,t,a){},221:function(e,t,a){},222:function(e,t,a){"use strict";a.r(t);var n=a(0),r=a.n(n),o=a(12),c=a.n(o),s=(a(152),a(3)),i=a(4),l=a(1),u=a(79),p=a(7),d=a(13),m=a(2),y=a(80),v=a.n(y),h=a(14),f=function e(){Object(h.a)(this,e)};f.MODE_DEFAULT="default",f.MODE_MENU="menu",f.MODE_EXTRUDE="extrude",f.MODE_MATERIALS="materials",f.STRUCTURE_MODE_EXTRUDE="structure_extrude",f.BASE_CELL_SIZE=30,f.CELL_SNAP_RATIO=.4;var g=a(227),b={players:{},structures:{},messages:[],partialPoints:[],cellSize:f.BASE_CELL_SIZE},O=["a","w","s","d","f","e","q"," ","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"];function E(e,t){var a=t.playerId||(t.player?t.player.id:void 0),n=a?e.players[a]:void 0;switch(t.type){case"update_player":return console.assert(void 0!==a,"Undefined playerId; required for:",t),Object(i.a)({},e,{players:Object(i.a)({},e.players,Object(m.a)({},a,t.player))});case"remove_player":console.assert(void 0!==a,"Undefined playerId; required for:",t);var r=Object(i.a)({},e);return delete r.players[a],r;case"update_local_player":return console.assert(void 0!==a,"Undefined playerId; required for:",t),Object(i.a)({},e,{localPlayerId:a,players:Object(i.a)({},e.players,Object(m.a)({},a,t.player))});case"update_structure":return Object(i.a)({},e,{structures:Object(i.a)({},e.structures,Object(m.a)({},t.structure.id,t.structure))});case"replace_state":return t.state;case"update_player_key_state":return console.assert(void 0!==a,"Undefined playerId; required for:",t),Object(i.a)({},e,{players:Object(i.a)({},e.players,Object(m.a)({},a,Object(i.a)({},n,{keyStates:Object(i.a)({},n.keyStates,Object(m.a)({},t.key,t.state))})))});case"add_player_message":return console.assert(void 0!==a,"Undefined playerId; required for:",t),Object(i.a)({},e,{messages:[].concat(Object(d.a)(e.messages),[t.message]),players:Object(i.a)({},e.players,Object(m.a)({},a,Object(i.a)({},n,{visibleMessages:[].concat(Object(d.a)(n.visibleMessages),[t.message])})))});case"remove_oldest_player_message":if(console.assert(void 0!==a,"Undefined playerId; required for:",t),n){var o=n.visibleMessages.slice();return o.shift(),Object(i.a)({},e,{players:Object(i.a)({},e.players,Object(m.a)({},a,Object(i.a)({},n,{visibleMessages:o})))})}return e;case"update_player_target":return console.assert(void 0!==a,"Undefined playerId; required for:",t),Object(i.a)({},e,{players:Object(i.a)({},e.players,Object(m.a)({},a,Object(i.a)({},n,{target:t.target})))});case"update_partial_points":return Object(i.a)({},e,{partialPoints:t.points.slice()});case"update_cell_size":return Object(i.a)({},e,{cellSize:t.cellSize});default:return console.log("unrecognized action: ",t),e}}function w(e,t,a,n){var r=t.localPlayerId;r&&t.players[r];switch(e.type){case"player_enter":console.log("player_enter: ",e.player),a({type:"update_player",player:e.player});break;case"player_exit":console.log("player_exit: ",e.player),t.players[e.player.id]&&e.player.id!==r&&a({type:"remove_player",playerId:e.player.id});break;case"full_state_request":n.emit("event",{type:"full_state_response",state:t});break;case"full_state_update":a({type:"replace_state",state:Object(i.a)({},e.state,{localPlayerId:r})});break;case"input_key_down":if(e.playerId===r)return;a({type:"update_player_key_state",key:e.key,state:!0,playerId:e.playerId});break;case"input_key_up":if(e.playerId===r)return;a({type:"update_player_key_state",key:e.key,state:!1,playerId:e.playerId});break;case"chat_message":if(e.playerId&&!t.players[e.playerId])break;var o=5e3+1e3*Math.floor(e.message.length/100);a({type:"add_player_message",playerId:e.player.id,message:Object(i.a)({},e)}),setTimeout((function(){a({type:"remove_oldest_player_message",playerId:e.player.id})}),o);break;case"player_target_change":if(e.playerId&&!t.players[e.playerId]||e.playerId===t.localPlayerId)break;a({type:"update_player_target",playerId:e.playerId,target:e.target});break;case"update_player":if(e.player.id===r)break;a({type:"update_player",player:e.player});break;case"update_structure":if(e.playerId===r)break;a({type:"update_structure",structure:e.structure});break;default:console.log("unrecognized server event: ",e)}}var j=function(){var e=Object(n.useReducer)(E,b),t=Object(s.a)(e,2),a=t[0],r=t[1],o=Object(n.useRef)();Object(n.useEffect)((function(){if(o.current){var e=o.current,t=a.players[a.localPlayerId];!function(e,t,a){var n=t.localPlayerId,r=n?t.players[n]:void 0;e.removeListener("event"),e.removeListener("disconnect"),e.removeListener("reconnect"),e.on("event",(function(n){w(n,t,a,e)})),e.on("disconnect",(function(n){w({type:"player_exit",localPlayer:r},t,a,e)})),e.on("reconnect",(function(t){e.emit("event",{type:"player_enter_request",localPlayer:r})}))}(e,a,r);var n=setInterval((function(){o.current.emit("event",{type:"update_player",player:t})}),2e3);return function(){clearInterval(n)}}}),[a]);var c=Object(n.useMemo)((function(){return Object(g.a)((function(e){return o.current.emit("event",e,1e3)}))}),[]);return{execute:Object(n.useMemo)((function(){return function(e,t){!function(e,t,a,n,r){var o=t.current,c=a.localPlayerId,s=c?a.players[c]:void 0;switch(console.assert(t.current||"initialize"===e.type,"tried executing action before initialization: ",e.type),e.type){case"initialize":t.current=v()("https://nameless-depths-23573.herokuapp.com"),n({type:"update_local_player",player:e.player}),t.current.emit("event",{type:"player_enter_request",player:e.player});break;case"key_down":if(!O.includes(e.key))return;n({type:"update_player_key_state",key:e.key,state:!0,playerId:c}),o.emit("event",{type:"input_key_down",playerId:c,key:e.key});break;case"key_up":if(!O.includes(e.key))return;n({type:"update_player_key_state",key:e.key,state:!1,playerId:c}),o.emit("event",{type:"input_key_up",playerId:c,key:e.key});break;case"update_player_target":n({type:"update_player_target",playerId:c,target:e.target}),r({type:"player_target_change",playerId:c,target:e.target});break;case"send_chat_message":o.emit("event",{type:"chat_message",message:e.message,player:s,time:new Date});break;case"update_structure":n(e),o.emit("event",Object(i.a)({},e,{playerId:c}));break;case"update_player":n(e),o.emit("event",e);break;default:new Error("unrecognized action:",e)}}(Object(i.a)({type:e},t),o,a,r,c)}}),[r,a,c]),state:a,dispatch:r}},_=a(18),k=function(){function e(){Object(h.a)(this,e)}return Object(_.a)(e,null,[{key:"listenFor",value:function(t,a,n){a.includedMeshes=n,e.eventMaps[t]=a}},{key:"removeListener",value:function(t){delete e.eventMaps[t]}},{key:"eventOccurred",value:function(t,a){Object.values(e.eventMaps).forEach((function(e){(!e.includedMeshes||e.includedMeshes.includes(a.object.id))&&e[t]&&e[t](a)}))}}]),e}();k.MOUSE_MOVE="mouse_move",k.CLICK="click",k.POINTER_OUT="pointer_out",k.POINTER_OVER="pointer_over",k.eventMaps={};var S=k,M=a(39),x=a(19),I=a(26),D=function(){function e(){Object(h.a)(this,e)}return Object(_.a)(e,null,[{key:"randString",value:function(e){for(var t="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=a.length,r=0;r<e;r++)t+=a.charAt(Math.floor(Math.random()*n));return t}},{key:"computeCompositeBoundingBox",value:function(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=[];e.walkNodes(t,(function(e){e.geometry&&((!a.excludedTypes||!a.excludedTypes.includes(e.userData.objectType))&&n.push(e))}));var r=new l.Box3;return n.forEach((function(e){e.updateMatrixWorld();var t=e.geometry.clone();t.applyMatrix(e.matrixWorld),t.computeBoundingBox(),r=r.union(t.boundingBox)})),r}},{key:"walkNodes",value:function(t,a){a(t);for(var n=0;n<t.children.length;n+=1)e.walkNodes(t.children[n],a)}},{key:"rand",value:function(e,t){return Math.random()*(t-e)+e}},{key:"vec3ToScreenPoint",value:function(e,t,a,n){var r=e.clone(),o=.5*a,c=.5*n;return r.project(t),r.x=r.x*o+o,r.y=-r.y*c+c,{x:r.x,y:r.y}}},{key:"exponentialEaseOut",value:function(e){return 1===e?1:1-Math.pow(2,-10*e)}},{key:"centroid",value:function(e){var t=e.length;return e.reduce((function(e,a,n){return e.x+=a.x,e.y+=a.y,e.z+=a.z,n===t-1&&(e.x/=t,e.y/=t,e.z/=t),e}),new l.Vector3(0,0,0))}},{key:"pointsAreEqual3D",value:function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.001;return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)+Math.pow(t.z-e.z,2))<a}},{key:"generateId",value:function(){return""+Math.round(1e6*Math.random())}},{key:"step",value:function(e,t){return t<=e?0:1}},{key:"smoothstep",value:function(e,t,a){var n=Math.max(0,Math.min(1,(a-e)/(t-e)));return n*n*(3-2*n)}},{key:"polygonArea",value:function(t){var a=0;t=t.map((function(e){return Array.isArray(e)?{x:e[0],y:e[1]}:e})),e.pointsAreEqual2D(t[0],t[t.length-1])||(t=t.concat(t[0]));for(var n=0;n<t.length-1;n+=1)a+=t[n].x*t[n+1].y-t[n].y*t[n+1].x;return Math.abs(a)/2}},{key:"pointsAreEqual2D",value:function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.001;return void 0!==e.x?Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))<a:Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))<a}},{key:"fract",value:function(e){return e-Math.floor(e)}},{key:"vecsEqual3D",value:function(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.001;return this.scratch1.subVectors(e,t).length()<a}}]),e}();D.scratch1=new l.Vector3;var V=D;var P=function(e,t){if(!e.partialPoints)return t.point;e.structures;var a=e.partialPoints,n=a[0],r=e.cellSize;if(n){var o=function(e,t,a){var n=t[0];if(!e.face)return console.log("No intersection face",e),e.point;var r=e.point.clone().sub(n),o=e.object.rotation.clone(),c=e.face.normal.clone().applyEuler(o).normalize(),s=new l.Vector3(0,0,1),i=new l.Vector3(0,1,0),u=new l.Vector3(1,0,0),p=new l.Quaternion;p.setFromUnitVectors(s,c),i.applyQuaternion(p),u.applyQuaternion(p);var d=u.dot(r),m=i.dot(r),y=new l.Vector2(d+a/2,m+a/2),v=new l.Vector2(Math.abs(V.fract(y.x/a))-.5,Math.abs(V.fract(y.y/a))-.5);if(1-V.step(f.CELL_SNAP_RATIO,v.length())>0){var h=Math.floor(y.x/a)*a,g=Math.floor(y.y/a)*a,b=u.clone().multiplyScalar(h),O=i.clone().multiplyScalar(g),E=b.clone().add(O),w=new l.Vector3(1,0,0),j=new l.Vector3(0,1,0),_=new l.Vector3(0,0,1),k=new l.Vector3(w.dot(E),j.dot(E),_.dot(E));return n.clone().add(k)}return null}(t,a,r);return o||t.point}return t.point},z=a(51),T=a.n(z),U=a(86),A=a(54),C={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1,moveUp:!1,moveDown:!1,crouch:!1,jump:!1,attack:!1},L=function(){function e(){Object(h.a)(this,e)}return Object(_.a)(e,null,[{key:"init",value:function(){var e=this,t={baseUrl:"models/ogro/",body:"ogro.md2",skins:["grok.jpg","ogrobase.png","arboshak.png","ctf_r.png","ctf_b.png","darkam.png","freedom.png","gib.png","gordogh.png","igdosh.png","khorne.png","nabogro.png","sharokh.png"],weapons:[["weapon.md2","weapon.jpg"]],animations:{move:"run",idle:"stand",jump:"jump",attack:"attack",crouchMove:"cwalk",crouchIdle:"cstand",crouchAttach:"crattack"},walkSpeed:1e3,crouchSpeed:175};this.skinCount=t.skins.length,this.base=new A.a,this.base.scale=1,this.basePromise=new Promise((function(t,a){e.base.onLoadComplete=function(){e.base.enableShadows(!0),e.base.setSkin(2),t(e.base)}})),this.base.loadParts(t)}},{key:"customizeMovement",value:function(e){var t;e.updateMovementModel=(t=e,function(e){var a=t.controls;t.decceleration=1500,t.maxSpeed=t.walkSpeed,void 0===t.t&&(t.t=100),t.moveDirection||(t.moveDirection=new l.Vector3);var n=a.moveForward?1:0,r=a.moveBackward?-1:0,o=a.moveRight?-1:0,c=a.moveLeft?1:0,s=a.moveUp?1:0,i=a.moveDown?-1:0;t.impulseDirection=new l.Vector3(o+c,s+i,n+r),t.impulseDirection.normalize();var u=new l.Vector3(0,0,1).applyAxisAngle(new l.Vector3(0,1,0),t.bodyOrientation),p=new l.Vector3(t.target.x,t.target.y,t.target.z).clone().sub(t.root.position).normalize();p.y=0;var d=u.cross(p).y;if(t.bodyOrientation+=d*e*10,t.impulseDirection.applyAxisAngle(new l.Vector3(0,1,0),t.bodyOrientation),t.impulseDirection.length()>0&&t.moveDirection.copy(t.impulseDirection),Math.abs(d)>.2&&(t.speed=d*e*10,d<0?a.moveLeft=!0:a.moveRight=!0),t.impulseDirection.length()>0)t.speed=t.maxSpeed;else{var m=V.exponentialEaseOut(t.speed/t.maxSpeed);t.speed=l.MathUtils.clamp(t.speed-m*e*t.decceleration,0,t.maxSpeed)}var y=t.moveDirection.clone().multiplyScalar(t.speed*e/10);t.root.position.add(y),t.root.rotation.y=t.bodyOrientation})}},{key:"getModelInstance",value:function(){var e=Object(U.a)(T.a.mark((function e(){var t,a,n=arguments;return T.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:this.instanceIndex,this.instanceIndex=(this.instanceIndex+1)%this.skinCount,(a=new A.a).scale=1,a.controls=this.getControlsCopy(),a.id=Math.random(),this.customizeMovement(a),e.next=9,this.basePromise.then((function(e){return a.shareParts(e),a.enableShadows(!0),a.setSkin(t),a.target=new l.Vector3,a.setWeapon(0),a}));case 9:return e.abrupt("return",e.sent);case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getControlsCopy",value:function(){var e={};return Object.keys(C).forEach((function(t){return e[t]=C[t]})),e}}]),e}();L.instanceIndex=2,L.init();var R=L;a(191);var F=function(e){var t=e.player,a=e.isLocalPlayer,o=e.t,c=Object(n.useState)(null),i=Object(s.a)(c,2),u=i[0],d=i[1],m=Object(n.useState)(0),y=Object(s.a)(m,2),v=y[0],h=y[1],f=Object(n.useState)(null),g=Object(s.a)(f,2),b=g[0],O=g[1],E=Object(p.e)().size;return Object(n.useRef)(),function(e,t){var a=Object(p.e)(),n=a.scene,r=a.size,o=a.camera;Object(p.d)((function(){var a=e.map((function(e){return document.querySelector(e)})),c=[];t.forEach((function(e){n.traverse((function(t){t.userData.name===e&&c.push(t)}))})),a.length===c.length&&a.forEach((function(e,t){var a=c[t],n=new l.Vector3;a.getWorldPosition(n);var s=V.vec3ToScreenPoint(n,o,r.width,r.height);e.style.position="absolute",e.style.zIndex="10000",e.style.transform="translateX(-50%)",e.style.left=s.x+"px",e.style.top=s.y+"px"}))}))}(["#player-label-"+t.id],["md2-root-"+t.id]),Object(n.useEffect)((function(){var e=document.createElement("div");e.id="player-label-"+t.id,e.className="scene-label",e.innerText=t.name;var a=document.getElementsByClassName("App")[0];return a.appendChild(e),function(){return a.removeChild(e)}}),[t.id,t.name]),Object(n.useEffect)((function(){if(u){if(-1===o||u.root.position.y>25)return;u.t=o,a||u.root.position.copy(t.position)}}),[o,u,t]),Object(n.useEffect)((function(){R.getModelInstance(t.skindex).then((function(e){var a=V.computeCompositeBoundingBox(e.root);e.root.userData.name="md2-root-"+t.id,h(a.getSize().y),d(e),e.root.position.set(t.position.x,e.root.position.y,t.position.z);var n=new I.a;n.setPositions([0,0,0,0,0,100]);var r=new x.a({color:6749969,linewidth:2,vertexColors:!1,dashed:!1,resolution:new l.Vector2(E.width,E.height)}),o=new M.a(n,r);e.root.add(o),O(o)}))}),[]),Object(p.d)((function(e,a){if(u){u.controls.moveForward=t.keyStates.w||t.keyStates.ArrowUp,u.controls.moveBackward=t.keyStates.s||t.keyStates.ArrowDown,u.controls.moveLeft=t.keyStates.a||t.keyStates.ArrowLeft,u.controls.moveRight=t.keyStates.d||t.keyStates.ArrowRight,u.controls.moveUp=t.keyStates.q,u.controls.moveDown=t.keyStates.e,u.controls.jump=t.keyStates[" "],u.controls.attack=t.keyStates.f,u.update(1.75*a),u.t+=1.75*a,u.root.position.y=Math.max(24.25,24.25+-18.369*Math.pow(u.t,2)*15+17.209*u.t*15),t.position.x=u.root.position.x,t.position.y=u.root.position.y,t.position.z=u.root.position.z,u.target=t.target;var n=new l.Vector3(t.position.x,t.position.y,t.position.z),r=new l.Vector3(u.target.x,u.target.y,u.target.z);r.sub(n),b.rotation.y=-u.bodyOrientation,b.geometry.setPositions([0,20,5,r.x,r.y,r.z]),b.geometry.needsUpdate=!0}})),r.a.createElement("mesh",null,u&&r.a.createElement(r.a.Fragment,null,r.a.createElement("primitive",{object:u.root,onClick:function(e){return console.log("click")}}),t.visibleMessages.map((function(e,a){return r.a.createElement(p.b,{key:e.time,center:!0,position:[t.position.x,t.position.y+v/1.5,t.position.z]},r.a.createElement("div",{style:{transform:"translateY(".concat(2.1*-a,"rem)")},className:"speech-bubble"},e.message))}))))},N=new l.Vector2,B=new l.Vector3,q=0;var X=function(e){var t=e.position,a=e.orientation,o=e.target,c=(e.targetUV,e.mouse),s=e.cellSize,i=Object(p.e)().size,u=Object(n.useRef)();Object(n.useEffect)((function(){if(u.current){var e=t.clone().addScaledVector(a,5);u.current.lookAt(e)}V.vecsEqual3D(a,B)||(q=0),B.copy(a)}),[t,a]);var d=Object(n.useMemo)((function(){return{vTarget:{value:o},planeSize:{value:new l.Vector2(1e4,1e4)},mouse:{value:c},cellSize:{value:s},targetUV:{value:N},time:{value:q}}}),[]);Object(p.d)((function(e,t){d.mouse.value.x=c.x,d.mouse.value.y=i.height-c.y,d.cellSize.value=s,d.vTarget.value=o,d.targetUV.value=N,q+=t,d.time.value=q}));var m="\n        varying vec3 norm;\n        varying vec2 pos;\n        varying vec2 vUv;\n        varying vec2 wTargetUV;\n\n        uniform vec2 planeSize;\n        uniform vec2 mouse;\n        uniform float cellSize;\n        uniform float time;\n\n        const float PI = 3.1418;\n\n        float gridValue(vec2 coord){\n            vec2 nCoord = (coord / cellSize);\n            vec2 grid = abs(fract(nCoord) - 0.5) / fwidth(nCoord*2.95);\n            float line = min(grid.x, grid.y);\n            return 1.0 - min(line, 1.0);\n        }\n\n        void main() {\n            vec4 blue = vec4(0., 0., 1.5, 0.75 * (clamp(0., 1., 3.*log(time + 0.9))));\n            float blendFactor = min(2.3 / length(fwidth(vUv)), 1.0);\n            float gridVal = gridValue(pos);\n            \n            // shift the 'spotlight' based on mouse pos\n            vec2 mouseOffset = (gl_FragCoord.xy - mouse) / planeSize.x;\n\n            \n            vec2 pointToJunction = abs(fract(pos / cellSize)) - 0.5;\n            float edgeDist = length(pointToJunction);\n            float steppedEdgeDist = (1. - smoothstep(".concat(f.CELL_SNAP_RATIO-.03,", ").concat(f.CELL_SNAP_RATIO,", edgeDist));\n\n            vec2 mouseToEdge = abs(fract(wTargetUV / cellSize)) - 0.5;\n            float steppedMouseDist = 1. - smoothstep(").concat(f.CELL_SNAP_RATIO-.03,", ").concat(f.CELL_SNAP_RATIO,", length(mouseToEdge));\n\n            vec2 mouseIndex = floor(wTargetUV / cellSize);\n            vec2 posIndex = floor(pos / cellSize);\n\n            // toggle snap point rendering depending on whether mouse and current\n            // pixel are near the same grid vertex\n            float toggle = 1. - clamp(0., 1., length(mouseIndex - posIndex));\n            vec2 mouseToPoint = pos - wTargetUV;\n            float rings = clamp(0., 1., mod(edgeDist*5. * (PI/2.) * 7. + time*4., 2.*PI) - 2.);\n            float snapVal = min(steppedMouseDist, steppedEdgeDist)*toggle*rings;\n\n            // Some of the constants here depend on planeSize\n            float spotlight = (1. - smoothstep(0.03, 0.05, length(vUv - 0.5 + mouseOffset)));\n\n            gl_FragColor = (1.-snapVal) * blue * gridVal * spotlight * blendFactor + vec4(1.0, 0., 1.0, 0.7) * snapVal;\n        }\n    ");return r.a.createElement("mesh",{ref:u,position:t,onPointerMove:function(e){N.x=e.uv.x,N.y=e.uv.y}},r.a.createElement("planeGeometry",{attach:"geometry",args:[1e4,1e4]}),r.a.createElement("shaderMaterial",{attach:"material",extensions:{derivatives:!0},blending:l.AdditiveBlending,depthTest:!0,depthWrite:!0,transparent:!0,side:l.DoubleSide,uniforms:d,fragmentShader:m,vertexShader:"\n        varying vec3 norm;\n        varying vec2 pos;\n        varying vec2 wTargetUV;\n        varying vec2 vUv;\n        \n        uniform float time;\n\n        uniform vec2 planeSize;\n        uniform vec2 mouse;\n        uniform vec2 targetUV;\n        uniform float cellSize;\n\n        void main() {\n            norm = normalize(normalMatrix * normal);\n            pos = (((uv - 0.5) * planeSize) + cellSize/2.);\n            wTargetUV = ((targetUV - 0.5) * planeSize) + cellSize/2.;\n            vUv = uv;\n\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    "}))},W=new l.Vector2,G={};Object(p.c)({LineMaterial:x.a,LineGeometry:I.a,Line2:M.a});var K=function(e){var t=e.player,a=e.snappedPoint,o=e.dispatch,c=e.finishStructureFunc,u=Object(n.useState)([]),y=Object(s.a)(u,2),v=y[0],h=y[1],g=Object(n.useState)(!1),b=Object(s.a)(g,2),O=b[0],E=b[1],w=Object(n.useState)({position:new l.Vector3,target:new l.Vector2,orientation:new l.Vector3,mouse:new l.Vector2}),j=Object(s.a)(w,2),_=j[0],k=j[1],M=Object(n.useState)(new l.Vector3),x=Object(s.a)(M,2),I=x[0],D=x[1],P=Object(n.useState)(null),z=Object(s.a)(P,2),T=z[0],U=z[1],A=Object(p.e)().size,C=v.length>0;Object(n.useEffect)((function(){o({type:"update_partial_points",points:v})}),[v,o]);var L=function(e,t){var a=e.object.rotation.clone(),n=e.face.normal.clone().applyEuler(a),r=n.clone().multiplyScalar(.2),o=t[0].clone().add(r),c=e.point.clone().add(r),s=n.clone().sub(I).length()<.1,u=e.object===T&&s?o:c;k(Object(i.a)({},_,{position:u,orientation:n.clone(),target:e.point.clone(),mouse:new l.Vector2(W.x,W.y),cellSize:f.BASE_CELL_SIZE,targetUV:e.uv.clone()}))};Object(n.useEffect)((function(){var e;return S.listenFor("partial_structure",(e={},Object(m.a)(e,S.MOUSE_MOVE,(function(e){C&&v.length>0&&L(e,v)})),Object(m.a)(e,S.CLICK,(function(e){if(!e.shiftKey){var t=e.object.rotation.clone(),n=e.face.normal.clone().applyEuler(t);0===v.length&&(console.log("setting parent normal"),D(n),U(e.object));var r=a.clone();r.id=V.generateId();var o=[].concat(Object(d.a)(v),[r]);h(o),L(e,o)}})),e)),function(){S.removeListener("partial_structure")}}),[v,a,C]);var R=Object(p.f)((function(e){if(v.length<1)e.setPositions(new Float32Array(150));else{if(v.length>2&&V.pointsAreEqual3D(v[0],v[v.length-1],.1)){var n=v.slice(0,v.length-1).map((function(e){return e.clone().sub(I.clone().multiplyScalar(.3))})),r={id:V.generateId(),owner:t.id,points:n,normal:I,extrusionParams:{depth:4,row:0,theta:0,bevelThickness:3,bevelSize:4,bevelSegments:4,steps:1}};c(r),h([]),E(!1)}var o=v.reduce((function(e,t){var a=t.x,n=t.y,r=t.z;return[].concat(Object(d.a)(e),[a,n,r])}),[],[]);for(o.push(a.x,a.y,a.z);o.length<150;)o.push(o[o.length-3],o[o.length-2],o[o.length-1]);o.length=Math.min(150,o.length),e.setPositions(o)}}),[v,a]);return r.a.createElement(r.a.Fragment,null,r.a.createElement("line2",null,r.a.createElement("lineGeometry",{attach:"geometry",ref:R}),r.a.createElement("lineMaterial",{attach:"material",color:6749969,linewidth:10,resolution:[A.width,A.height]})),v.map((function(e,t){return r.a.createElement("mesh",{key:e.id,castShadow:!0,position:[e.x,e.y,e.z]},r.a.createElement("sphereGeometry",{attach:"geometry",args:[0===t&&O?30:7,32,32]}),r.a.createElement("meshPhysicalMaterial",{attach:"material",color:0===t&&O?65280:1144576,clearcoat:!0,metalness:.25,clearcoatRoughness:.75,roughness:.1}))})),C&&r.a.createElement(X,{position:_.position,orientation:_.orientation,target:_.target,mouse:_.mouse,cellSize:_.cellSize,targetUV:_.targetUV}))};var Q=function(e){var t=e.structure,a=e.updateStructure,o=e.active,c=(e.player,e.onPointerMove),i=e.onClick,u=e.onPointerOut,p=e.mode,d=e.setMode,y=e.shiftDown,v=(e.mouseTravel,Object(n.useState)(null)),h=Object(s.a)(v,2),g=h[0],b=h[1],O=Object(n.useState)(!1),E=Object(s.a)(O,2),w=E[0],j=E[1],_=Object(n.useState)(null),k=Object(s.a)(_,2),M=(k[0],k[1],Object(n.useState)(new l.Vector3)),x=Object(s.a)(M,2),I=x[0],D=x[1],P=Object(n.useRef)();Object(n.useEffect)((function(){var e=V.centroid(t.points),a=(new l.Vector3).copy(t.normal),n=new l.Vector3(0,0,1),r=new l.Quaternion;r.setFromUnitVectors(a,n);var o=t.points.map((function(t){return new l.Vector3(t.x-e.x,t.y-e.y,t.z-e.z)})).map((function(e){return e.clone().applyQuaternion(r)}));b(new l.Shape(o.map((function(e){return new l.Vector2(e.x,e.y)})))),D(e)}),[t.points]),Object(n.useEffect)((function(){var e,n=function(e){if(e.shiftKey){var a=e.face.a;a>=0&&a<=6*(t.points.length-2)?j(!0):j(!1)}else j(!1)};P.current&&S.listenFor("structure_"+t.id,(e={},Object(m.a)(e,S.MOUSE_MOVE,n),Object(m.a)(e,S.CLICK,(function(e){p===f.MODE_DEFAULT?e.shiftKey&&d(f.MODE_EXTRUDE,t.id):o&&p===f.MODE_EXTRUDE&&a(t)})),Object(m.a)(e,S.POINTER_OUT,(function(e){j(!1)})),Object(m.a)(e,S.POINTER_OVER,n),e),[P.current.id])}),[P.current,w,t,p,o]);var z=o&&p===f.MODE_EXTRUDE,T=g&&w&&p===f.MODE_DEFAULT;return r.a.createElement(r.a.Fragment,null,g&&r.a.createElement("mesh",{ref:P,quaternion:U(t.normal),position:I,castShadow:!0,receiveShadow:!0,onPointerMove:c,onClick:i,onPointerOut:u},r.a.createElement("extrudeBufferGeometry",{attach:"geometry",args:[g,t.extrusionParams]}),z&&r.a.createElement("meshPhysicalMaterial",{attach:"material",color:0,emissive:65280,emissiveIntensity:.7,metalness:.9,roughness:.1,clearcoat:!0,clearcoatRoughness:.25}),!z&&r.a.createElement("meshPhysicalMaterial",{attach:"material",color:16777215,emmissive:65280,metalness:.9,roughness:.1,clearcoat:!0,clearcoatRoughness:.25})),g&&p!==f.MODE_EXTRUDE&&y&&r.a.createElement("mesh",{quaternion:U(t.normal),position:function(e,t,a){return e.clone().addScaledVector(t,a+1.5)}(I,t.normal,t.extrusionParams.depth)},r.a.createElement("extrudeBufferGeometry",{attach:"geometry",args:[g,{depth:1,bevelSize:1,bevelThickness:1,bevelSegments:2}]}),T&&r.a.createElement("meshPhysicalMaterial",{attach:"material",color:16777215,emissive:13277,metalness:.9,roughness:.1,clearcoat:!0,clearcoatRoughness:.25}),!T&&r.a.createElement("meshPhysicalMaterial",{attach:"material",color:16777215,emissive:13277,emissiveIntensity:.15,metalness:.9,roughness:.1,clearcoat:!0,clearcoatRoughness:.25})));function U(e){var t=new l.Quaternion;return t.setFromUnitVectors(new l.Vector3(0,0,1),e),t}},J=(a(192),a(226));var Y=function(e){var t=e.sendChatMessage,a=e.localPlayer,o=(e.players,e.messages),c=e.hideChat,i=Object(n.useState)(""),l=Object(s.a)(i,2),u=l[0],p=l[1],d=Object(n.useRef)();return Object(n.useEffect)((function(){d.current.scrollTop=d.current.scrollHeight}),[o]),r.a.createElement("div",{className:"ChatWindow"},r.a.createElement("div",{className:"all-messages",ref:d},o.map((function(e){return r.a.createElement("div",{className:"chat-message",key:e.time},r.a.createElement("div",{className:"chat-message-name"},e.player.name,":"),r.a.createElement("div",{className:"chat-message-content"},e.message))}))),r.a.createElement(J.c,{className:"your-message",placeholder:"your message...",large:!0,onKeyDown:function(e){13===e.which?(t({message:u,playerId:a.id,time:new Date}),p("")):27===e.which&&c(),e.stopPropagation()},value:u,onChange:function(e){return p(e.target.value)},autoFocus:!0}))},Z=a(91),H=a(90),$=a(92),ee=a(93);a(219);Object(p.c)({EffectComposer:Z.a,RenderPass:H.a,UnrealBloomPass:ee.a,SSAOPass:$.a});var te=new u.a,ae=new l.Vector3(0,100,100),ne=new l.Vector3(0,0,0),re=new l.Vector3,oe=1,ce=function(e){var t=e.localPlayer,a=e.mode,n=Object(p.e)(),r=n.camera;n.scene;return Object(p.d)((function(){if(te.update(),a===f.MODE_DEFAULT){var e=t.position,n=t.target,o=new l.Vector3(e.x,e.y,e.z),c=o.set(o.x,o.y+70,o.z),s=new l.Vector3(n.x,n.y,n.z).clone().sub(c).normalize().clone().multiplyScalar(-200*oe);s.z=Math.max(Math.abs(s.z),50)*Math.sign(s.z),s.y=Math.max(s.y,50),ae.copy(o.clone().add(s)),ne.copy(o);var i=l.MathUtils.clamp(r.position.clone().sub(ae).length()/10,.1,4);r.position.copy(r.position.lerp(ae,.005*i));var u=re.lerp(ne,.05).clone();r.lookAt(u),r.updateProjectionMatrix()}})),null};function se(e){var t=e.ssao,a=e.bloom,o=Object(p.e)(),c=o.gl,s=o.scene,i=o.camera,l=o.size,u=Object(n.useRef)();return Object(n.useEffect)((function(){u.current.setSize(l.width,l.height)}),[l]),Object(p.d)((function(){return u.current.render()}),1),r.a.createElement("effectComposer",{ref:u,args:[c]},r.a.createElement("renderPass",{attachArray:"passes",args:[s,i]}),a&&r.a.createElement("unrealBloomPass",{attachArray:"passes",args:[void 0,1.5,.4,.6],bloomThreshold:1,bloomStrength:1,bloomRadius:0}),t&&r.a.createElement("sSAOPass",{attachArray:"passes",args:[s,i,l.width,l.height],kernelRadius:16,minDistance:.005,maxDistance:50}))}function ie(e){var t=e.mode,a=e.setMode,r=e.execute,o=e.structures,c=e.chatVisible,s=e.setChatVisible,l=e.setT,u=e.setShiftDown,d=e.activeObjectId,m=(e.setActiveObjectId,e.mouseTravel),y=e.setMouseTravel,v=Object(p.e)(),h=v.gl;v.size;return Object(n.useEffect)((function(){h.domElement.onclick=function(e){switch(t){case f.MODE_DEFAULT:s(!1);break;case f.MODE_EXTRUDE:a(f.MODE_DEFAULT)}},window.onkeydown=function(e){9===e.which&&(e.preventDefault(),s(!c)),G[e.key]=!0,r("key_down",Object(i.a)({},e,{which:e.which,key:e.key})),"Shift"===e.key&&u(!0)," "===e.key&&(l(0),l(-1))},window.onkeyup=function(e){G[e.key]=!0,"Shift"===e.key&&u(!1),r("key_up",Object(i.a)({},e,{which:e.which,key:e.key}))},h.domElement.onmousemove=function(e){switch(W.x=e.clientX,W.y=e.clientY,t){case f.MODE_DEFAULT:break;case f.MODE_EXTRUDE:y({x:m.x+e.movementX,y:m.y+e.movementY})}},h.domElement.onwheel=function(e){switch(t){case f.MODE_DEFAULT:e.preventDefault(),oe+=.01*e.deltaY,oe=Math.min(Math.max(.05,oe),3);break;case f.MODE_EXTRUDE:var a=o[d],n=Math.max(0,a.extrusionParams.depth+e.deltaY),c=Object(i.a)({},a,{extrusionParams:Object(i.a)({},a.extrusionParams,{depth:n})});r("update_structure",{structure:c})}}}),[h,c,t,d,o,m]),null}var le=function(e){var t=e.playerInfo,a=Object(n.useState)(!1),o=Object(s.a)(a,2),c=o[0],i=o[1],u=Object(n.useState)(null),d=Object(s.a)(u,2),m=d[0],y=d[1],v=Object(n.useState)({x:0,y:0}),h=Object(s.a)(v,2),g=h[0],b=h[1],O=Object(n.useState)(100),E=Object(s.a)(O,2),w=E[0],_=E[1],k=Object(n.useMemo)((function(){return(new l.TextureLoader).load("rust2.jpg")}),[]),M=Object(n.useState)(f.MODE_DEFAULT),x=Object(s.a)(M,2),I=x[0],D=x[1],V=Object(n.useState)(!1),z=Object(s.a)(V,2),T=z[0],U=z[1],A=j(),C=A.execute,L=A.dispatch,R=A.state,N=R.players[R.localPlayerId],B=Object(n.useState)(new l.Vector3),q=Object(s.a)(B,2),X=q[0],W=q[1],G=Object(n.useRef)(),J=X;Object(n.useEffect)((function(){C("initialize",{player:t}),console.log("executed initialize!")}),[t]),Object(n.useEffect)((function(){G.current&&(G.current.target.position.copy(new l.Vector3(0,0,0)),G.current.target.updateMatrixWorld())}),[G.current]);var Z=function(e){e.stopPropagation(),J=P(R,e),W(J),C("update_player_target",{target:J,playerId:N.id}),S.eventOccurred(S.MOUSE_MOVE,e)},H=function(e){e.stopPropagation(),S.eventOccurred(S.CLICK,e)},$=function(e){S.eventOccurred(S.POINTER_OUT,e)},ee=function(e){S.eventOccurred(S.POINTER_OVER,e)},te=function(e){C("update_structure",{structure:e}),y(null),b({x:0,y:0}),D(f.MODE_DEFAULT)};return r.a.createElement("div",{className:"main-canvas-container"},r.a.createElement(p.a,{style:{backgroundColor:"#789"},gl:{antialias:!1,alpha:!1},pixelRatio:1,camera:{position:[0,10,10],near:1,far:4e3},shadowMap:!0,onCreated:function(e){var t=e.gl;t.toneMapping=l.Uncharted2ToneMapping,t.outputEncoding=l.sRGBEncoding,t.shadowMap.type=l.PCFSoftShadowMap,t.setClearColor(new l.Color("#667788"))}},r.a.createElement(se,null),r.a.createElement(ie,{mode:I,setMode:D,execute:C,structures:R.structures,chatVisible:c,setChatVisible:i,activeObjectId:m,setActiveObjectId:y,mouseTravel:g,setMouseTravel:b,setT:_,setShiftDown:U}),r.a.createElement(ce,{localPlayer:N,mode:I}),r.a.createElement("fog",{attach:"fog",args:[6715272,500,1500]}),r.a.createElement("ambientLight",{args:[6710886]}),r.a.createElement("directionalLight",{args:[16777215,7],position:[0,6e3,3e3],"shadow-camera-left":-1e3,"shadow-camera-bottom":-1e3,"shadow-camera-right":1e3,"shadow-camera-top":1e3,"shadow-camera-near":1,"shadow-camera-far":12e3,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,castShadow:!0}),r.a.createElement("directionalLight",{args:[10066431,7],ref:G,position:[500,5e3,-1e3],"shadow-camera-left":-1e3,"shadow-camera-bottom":-1e3,"shadow-camera-right":1e3,"shadow-camera-top":1e3,"shadow-camera-near":1,"shadow-camera-far":12e3,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024,castShadow:!0}),Object.values(R.players).map((function(e){return r.a.createElement(F,{key:e.id,t:w,player:e,isLocalPlayer:e.id===N.id})})),I===f.MODE_DEFAULT&&r.a.createElement(K,{player:N,snappedPoint:J,dispatch:L,finishStructureFunc:function(e){C("update_structure",{structure:e}),D(f.MODE_EXTRUDE),y(e.id)}}),Object.values(R.structures).map((function(e){return r.a.createElement(Q,{key:e.id,structure:e,updateStructure:te,player:N,onPointerMove:Z,onClick:H,onPointerOut:$,onPointerOver:ee,mode:I,active:m===e.id,shiftDown:T,setMode:function(e,t){D(e),t&&y(t)},mouseTravel:g})})),r.a.createElement("mesh",{receiveShadow:!0,"rotation-x":-Math.PI/2,onPointerMove:Z,onClick:H},r.a.createElement("planeBufferGeometry",{attach:"geometry",args:[16e3,16e3]}),r.a.createElement("meshStandardMaterial",{attach:"material",color:3355443,roughness:.55,metalness:.8},r.a.createElement("primitive",{attach:"map",object:k,repeat:[64,64],wrapS:l.RepeatWrapping,wrapT:l.RepeatWrapping,encoding:l.sRGBEncoding})))),c&&r.a.createElement(Y,{players:R.players,sendChatMessage:function(e){C("send_chat_message",e)},localPlayer:N,messages:R.messages,hideChat:function(){return i(!1)}}))},ue=(a(220),function(){function e(){Object(h.a)(this,e)}return Object(_.a)(e,null,[{key:"create",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:V.randString(V.rand(3,12));return{name:e,id:V.generateId(),position:new l.Vector3(V.rand(-100,100),0,V.rand(-100,100)),visibleMessages:[],keyStates:{},target:new l.Vector3,skindex:5003*e.length%13}}},{key:"addMessage",value:function(e,t){return Object(i.a)({},e,{visibleMessages:[].concat(Object(d.a)(e.visibleMessages),[t])})}},{key:"removeOldestMessage",value:function(e){var t=e.visibleMessages.slice();return t.shift(),Object(i.a)({},e,{visibleMessages:t})}}]),e}());var pe=function(e){var t=e.logIn,a=Object(n.useState)(""),o=Object(s.a)(a,2),c=o[0],i=o[1];return r.a.createElement("div",{className:"login-container bp3-light"},r.a.createElement(J.b,{label:"Choose a name to use:"},r.a.createElement(J.c,{autoFocus:!0,placeholder:"name...",large:!0,onChange:function(e){var t=e.target.value||"";i(t)},onKeyDown:function(e){return 13===e.which?t(ue.create(c)):""}})),r.a.createElement(J.a,{onClick:function(){t(ue.create(c))}},"Join"))};a(221);var de=function(){var e=Object(n.useState)(!1),t=Object(s.a)(e,2),a=t[0],o=t[1],c=Object(n.useState)(null),i=Object(s.a)(c,2),l=i[0],u=i[1],p=function(e){u(e),o(!0)};return Object(n.useEffect)((function(){0}),[]),r.a.createElement("div",{className:"App bp3-dark"},l&&r.a.createElement(le,{playerInfo:l}),r.a.createElement("div",{className:"screen-container"},!a&&r.a.createElement(pe,{logIn:p})))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));c.a.render(r.a.createElement(r.a.StrictMode,null,r.a.createElement(de,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[148,1,2]]]);
//# sourceMappingURL=main.83b975c2.chunk.js.map