{"version":3,"sources":["Util.js","PlayerData.js","playground.js","constants.js","MeshEvents.js","ModelFactory.js","components/Player.js","components/w-hooks.js","components/PartialStructure.js","components/Structure.js","components/ChatWindow.js","MainCanvas.js","components/LoginPrompt.js","App.js","serviceWorker.js","index.js"],"names":["Util","length","result","characters","charactersLength","i","charAt","Math","floor","random","obj3d","options","allMeshes","walkNodes","node","geometry","excludedTypes","includes","userData","objectType","push","totalBox","Box3","forEach","mesh","updateMatrixWorld","geometryCopy","clone","applyMatrix","matrixWorld","computeBoundingBox","union","boundingBox","func","children","min","max","vector","camera","canvasWidth","canvasHeight","vectorCopy","widthHalf","heightHalf","project","x","y","k","pow","points","l","reduce","center","p","z","Vector3","p1","p2","threshold","sqrt","round","Player","name","randString","rand","id","generateId","position","visibleMessages","keyStates","target","skindex","player","message","slice","shift","Playground","updatePlayers","updateMessagesFunc","socket","state","players","messages","this","localPlayerId","connectToServer","io","emit","type","on","data","handleServerEvent","sendMouseMove","throttle","playerId","getLocalPlayer","periodicSyncInterval","setInterval","event","console","log","getPlayersArray","serverKeyDown","serverKeyUp","messageDisplayTime","addMessage","setTimeout","removeOldestMessage","Object","values","concat","keys","map","key","e","RECOGNIZED_KEYS","time","Date","KEY_TO_DIRECTION","a","w","s","d","Const","PLAYER_MODE_CREATE","PLAYER_MODE_EDIT","PLAYER_MODE_DRAG","PLAYER_MODE_OBJECT","MeshEvents","eventsToHandlers","includedMeshes","eventMaps","handlerMap","object","MOUSE_MOVE","CLICK","POINTER_OUT","MD2_CONTROLS","moveForward","moveBackward","moveLeft","moveRight","moveUp","moveDown","crouch","jump","attack","ModelFactory","configOgro","baseUrl","body","skins","weapons","animations","move","idle","crouchMove","crouchIdle","crouchAttach","walkSpeed","crouchSpeed","skinCount","base","MD2CharacterComplex","scale","basePromise","Promise","resolve","reject","onLoadComplete","enableShadows","setSkin","loadParts","instance","self","updateMovementModel","delta","controls","decceleration","maxSpeed","moveDirection","impulseDirection","normalize","forwardVec","applyAxisAngle","bodyOrientation","toTarget","sub","root","rotationGap","cross","copy","abs","speed","exponentialEaseOut","MathUtils","clamp","deltaVec","multiplyScalar","add","rotation","skin","instanceIndex","getControlsCopy","customizeMovement","then","shareParts","setWeapon","init","mode","useState","md2","setMd2","height","setHeight","laser","setLaser","size","useThree","domSelectors","sceneNames","scene","useFrame","domNodes","document","querySelector","sceneNodes","nodeName","traverse","dNode","sNode","worldPoint","getWorldPosition","screenPoint","vec3ToScreenPoint","width","style","zIndex","transform","left","top","useDOM","useEffect","label","createElement","innerText","getElementsByClassName","appendChild","getModelInstance","bbox","computeCompositeBoundingBox","getSize","set","LineGeometry","setPositions","lineProps","color","error","linePropsForMode","matLine","LineMaterial","linewidth","vertexColors","dashed","resolution","Vector2","line","Line2","info","update","pos","THREE","tar","needsUpdate","onClick","className","extend","PartialStructure","finishStructureFunc","setPoints","cursorPoint","setCursorPoint","inSnapRange","setInSnapRange","listenFor","vec","point","finish","snapDiffVec","normal","face","applyEuler","centroid","extrusionLine","start","end","addScaledVector","structure","removeListener","ref","useUpdate","geom","Float32Array","MAX_POLY_POINTS","modCursorPoint","finalPoints","acc","attach","castShadow","args","clearcoat","metalness","clearcoatRoughness","roughness","Structure","onPointerMove","onPointerOut","playerMode","setPlayerMode","baseShape","setBaseShape","steps","depth","bevelThickness","bevelSize","bevelSegments","extrudeSettings","setExtrudeSettings","overMainFace","setOverMainFace","dragStartPoint","setDragStartPoint","meshRef","useRef","Shape","dragLine","newDepth","dot","current","hoverFaceIndex","rotation-x","PI","position-y","receiveShadow","emissive","ChatWindow","sendChatMessage","hideChat","inputText","setInputText","allMessagesRef","scrollTop","scrollHeight","placeholder","large","onKeyDown","which","value","onChange","autoFocus","EffectComposer","RenderPass","UnrealBloomPass","SSAOPass","stats","Stats","camDest","camLookAtDest","lastLookAtVec","camZoom","CameraController","playground","positionObj","targetObj","shiftedPosition","extension","sign","lerp","newLookAt","lookAt","updateProjectionMatrix","InputHandler","setChatVisible","chatVisible","gl","domElement","onclick","localClick","window","onkeydown","preventDefault","localKeyDown","onkeyup","localKeyUp","onmousemove","localMouseMove","onwheel","deltaY","Effects","ssao","bloom","composer","setSize","render","attachArray","undefined","bloomThreshold","bloomStrength","bloomRadius","kernelRadius","minDistance","maxDistance","MainCanvas","setPlayers","setMessages","setPlayground","structures","setStructures","grassTexture","useMemo","load","handleMeshMouseMove","eventOccurred","handleMeshClick","handleMeshPointerOut","backgroundColor","antialias","alpha","pixelRatio","devicePixelRatio","near","far","shadowMap","onCreated","toneMapping","outputEncoding","setClearColor","shadow-camera-left","shadow-camera-bottom","shadow-camera-right","shadow-camera-top","shadow-camera-near","shadow-camera-far","shadow-mapSize-width","shadow-mapSize-height","repeat","wrapS","wrapT","encoding","bind","LoginPrompt","logIn","setName","text","create","App","loggedIn","setLoggedIn","setPlayer","doLogin","Boolean","location","hostname","match","ReactDOM","StrictMode","getElementById","navigator","serviceWorker","ready","registration","unregister","catch"],"mappings":"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","file":"static/js/main.3fbdd2bf.chunk.js","sourcesContent":["import {Box3, Vector3} from 'three'\n\nclass Util {\n    static randString(length) {\n        var result = ''\n        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n        var charactersLength = characters.length\n        for (var i = 0; i < length; i++) {\n            result += characters.charAt(Math.floor(Math.random() * charactersLength))\n        }\n        return result\n    }\n\n    /*\n        Computes a bounding box which is the union of the geometry\n        belonging to the passed in node and all descendent meshes.\n        This exists because the Three.Box3().setFromObject() method\n        is brokenâ€”possibly having to do with THREE.Group nodes.\n    */\n    static computeCompositeBoundingBox(obj3d, options = {}) {\n        const allMeshes = [];\n\n        Util.walkNodes(obj3d, node => {\n            if (node.geometry) {\n                const notExcluded =\n                    !options.excludedTypes ||\n                    !options.excludedTypes.includes(node.userData.objectType);\n\n                if (notExcluded) allMeshes.push(node);\n            }\n        });\n\n        let totalBox = new Box3();\n        allMeshes.forEach(mesh => {\n            mesh.updateMatrixWorld();\n            const geometryCopy = mesh.geometry.clone();\n            geometryCopy.applyMatrix(mesh.matrixWorld);\n            geometryCopy.computeBoundingBox();\n            totalBox = totalBox.union(geometryCopy.boundingBox);\n        });\n\n        return totalBox;\n    }\n\n    /*\n        Depth first walk of a three.js node and all of its children.\n        The passed in function is called at each node, and the current\n        node is passed in as the sole argument.\n    */\n    static walkNodes(node, func) {\n        func(node);\n\n        for (let i = 0; i < node.children.length; i += 1) {\n            Util.walkNodes(node.children[i], func);\n        }\n    }\n\n    static rand(min, max) {\n        return Math.random() * (max - min) + min\n    }\n\n    static vec3ToScreenPoint(vector, camera, canvasWidth, canvasHeight) {\n        // Make a copy since .project(...) will transform the vector\n        const vectorCopy = vector.clone();\n\n        const widthHalf = 0.5 * canvasWidth;\n        const heightHalf = 0.5 * canvasHeight;\n\n        vectorCopy.project(camera);\n\n        vectorCopy.x = vectorCopy.x * widthHalf + widthHalf;\n        vectorCopy.y = -(vectorCopy.y * heightHalf) + heightHalf;\n\n        return {\n            x: vectorCopy.x,\n            y: vectorCopy.y,\n        };\n    }\n\n    static exponentialEaseOut(k) {\n        return k === 1 ? 1 : - Math.pow(2, - 10 * k) + 1;\n    }\n\n    /*\n    From: https://github.com/ayamflow/polygon-centroid\n  */\n    static centroid(points) {\n        const l = points.length;\n\n        return points.reduce((center, p, i) => {\n            center.x += p.x;\n            center.y += p.y;\n            center.z += p.z;\n\n            if (i === l - 1) {\n                center.x /= l;\n                center.y /= l;\n                center.z /= l;\n            }\n\n            return center;\n        }, new Vector3(0, 0, 0));\n    }\n\n    static pointsAreEqual3D(p1, p2, threshold = 0.001) {\n        return (\n            Math.sqrt((p2.x - p1.x) ** 2 + (p2.y - p1.y) ** 2 + (p2.z - p1.z) ** 2) <\n            threshold\n        );\n    }\n\n    static generateId() {\n        return \"\" + Math.round(Math.random() * 1000000)\n    }\n}\n\nexport default Util","import  {Vector3} from \"three\"\nimport Util from './Util'\n\nconst player_skin_count = 13\n\nclass Player {\n\n    static create(name = Util.randString(Util.rand(3, 12))) {\n        return  {\n                    name,\n                    id: Util.generateId(),\n                    position: new Vector3(Util.rand(-100, 100), 0, Util.rand(-100, 100)),\n                    visibleMessages: [],\n                    keyStates: {},\n                    target: new Vector3(),\n                    skindex: (name.length * 5003) % player_skin_count\n                }\n    }\n\n    static addMessage(player, message) {\n        const newPlayer = {...player, visibleMessages: [...player.visibleMessages, message]}\n        return newPlayer\n    }\n\n    static removeOldestMessage(player) {\n        const visibleMessages = player.visibleMessages.slice()\n        visibleMessages.shift()\n        return {...player, visibleMessages}\n    }\n}\n\nexport default Player","import io from \"socket.io-client\"\nimport Player from './PlayerData'\nimport {throttle} from 'lodash-es'\n\nconst isProduction = process.env.NODE_ENV !== 'development'\nconst port = 3000\nconst devURL = \"localhost:\" + port\nconst prodURL = \"https://nameless-depths-23573.herokuapp.com\"\nconst serverURL = isProduction ? prodURL : devURL\nconst PERIODIC_SYNC_TIME = 2000\nconst TARGET_UPDATE_THROTTLE = 1000\n\nclass Playground {\n    localPlayerId\n    socket = null\n    state = {players: {}}\n    messages = []\n\n    static RECOGNIZED_KEYS = [\"a\", \"w\", \"s\", \"d\", \"f\", \"e\", \"q\", \" \", \"ArrowUp\", \"ArrowDown\", \"ArrowLeft\", \"ArrowRight\"]\n    static KEY_TO_DIRECTION = { a: 'left', w: \"up\", s: \"down\", d: \"right\"}\n\n    constructor(player, updatePlayers, updateMessagesFunc) {\n        this.localPlayerId = player.id\n        this.updatePlayers = updatePlayers\n        this.updateMessagesFunc = updateMessagesFunc\n        this.state.players[player.id] = player\n\n        this.connectToServer(player)\n    }\n\n    connectToServer(player) {\n        this.socket = io(serverURL)\n        this.socket.emit(\"event\", { type: \"player_enter_request\", player })\n\n        this.socket.on(\"event\", data => {\n            // console.log(\"server event: \", data)\n\n            this.handleServerEvent(data)\n        })\n\n        this.socket.on(\"disconnect\", data => {\n            // This is a hack: it's not a server event, but we\n            // want to use the same logic for now\n            this.handleServerEvent({type: \"player_exit\", player})\n        })\n\n        this.socket.on(\"reconnect\", data => {\n            this.socket.emit(\"event\", { type: \"player_enter_request\", player })\n        })\n\n        this.sendMouseMove = throttle(() => this.socket.emit(\"event\", { type: \"player_target_change\", playerId: this.localPlayerId, target: this.getLocalPlayer().target }), TARGET_UPDATE_THROTTLE)\n\n        this.periodicSyncInterval = setInterval(() => {\n            this.socket.emit(\"event\", { type: \"player_sync\", player: this.getLocalPlayer() })\n        }, PERIODIC_SYNC_TIME)\n    }\n\n    handleServerEvent(event) {\n        \n        let player\n        if (event.playerId)\n            player = this.state.players[event.playerId]\n\n        switch (event.type) {\n            case \"player_enter\":\n                console.log(\"player_enter: \", event.player)\n                this.state.players[event.player.id] = event.player\n                this.updatePlayers(this.getPlayersArray())\n                break;\n            case \"player_exit\":\n                console.log(\"player_exit: \", event.player)\n                if (this.state.players[event.player.id] && event.player.id !== this.localPlayerId) {\n                    delete this.state.players[event.player.id]\n                    this.updatePlayers(this.getPlayersArray())\n                }\n                break;\n            case \"full_state_request\":\n                this.socket.emit(\"event\", { type: \"full_state_response\", state: this.state})\n                break;\n            case \"full_state_update\":\n                this.state = event.state\n                this.updatePlayers(this.getPlayersArray())\n                break;\n            case \"input_key_down\":\n                this.serverKeyDown(event)\n                break;\n            case \"input_key_up\":\n                this.serverKeyUp(event)\n                break;\n            case \"input_mouse_move\":\n\n                break;\n            case \"input_click\":\n\n                break;\n            case \"chat_message\":\n                if ((event.playerId && !this.state.players[event.playerId])) {\n                    break\n                }\n\n                const message = {...event, player}\n                const messageDisplayTime = 5000 + (1000 * Math.floor(message.message.length / 100))\n                this.state.players = { ...this.state.players, [event.playerId]: Player.addMessage(player, message)}\n\n                setTimeout(() => {\n                    this.state.players = { ...this.state.players, [event.playerId]: Player.removeOldestMessage(this.state.players[event.playerId])}\n                    this.updatePlayers(Object.values(this.state.players))\n                }, messageDisplayTime)\n\n                this.messages = this.messages.concat(message)\n                this.updateMessagesFunc(this.messages)\n                this.updatePlayers(Object.values(this.state.players))\n                break;\n            case \"player_target_change\":\n                if ((event.playerId && !this.state.players[event.playerId])) {\n                    break\n                }\n\n                this.state.players = { ...this.state.players, [event.playerId]: {...player, target: event.target} }\n                this.updatePlayers(Object.values(this.state.players))\n                break;\n            case \"player_sync\":\n                if (event.player.id === this.localPlayerId)\n                    break\n\n                this.state.players[event.player.id] = event.player\n                this.updatePlayers(Object.values(this.state.players))\n                break;\n            default:\n                console.log(\"unrecognized server event: \", event)\n                break;\n        }\n    }\n\n    getPlayersArray() {\n        return Object.keys(this.state.players).map(key => this.state.players[key])\n    }\n\n    /////\n    // Server event handlers\n    ////\n\n    serverKeyDown(event) {\n        if (event.playerId === this.localPlayerId)\n            return\n\n        const key = event.key\n        this.state.players[event.playerId].keyStates[key] = true\n    }\n\n    serverKeyUp(event) {\n        if (event.playerId === this.localPlayerId)\n            return\n\n        const key = event.key\n        this.state.players[event.playerId].keyStates[key] = false\n    }\n\n    /////\n    // Local input handlers\n    ////\n\n    localKeyDown(e) {\n        const key = e.key\n\n        if (!Playground.RECOGNIZED_KEYS.includes(key))\n            return\n\n        this.state.players[this.localPlayerId].keyStates[key] = true\n\n        this.socket.emit(\"event\", { type: \"input_key_down\", playerId: this.localPlayerId, key })\n    }\n\n    localKeyUp(e) {\n        const key = e.key\n\n        if (!Playground.RECOGNIZED_KEYS.includes(key))\n            return\n\n        this.state.players[this.localPlayerId].keyStates[key] = false\n\n        this.socket.emit(\"event\", { type: \"input_key_up\", playerId: this.localPlayerId, key })\n    }\n\n    localMouseMove(e) {\n        this.sendMouseMove()\n    }\n\n    localClick(e) {\n        this.socket.emit(\"event\", { type: \"input_click\", playerId: this.localPlayerId})\n    }\n\n    sendChatMessage(message) {\n        this.socket.emit(\"event\", {type: \"chat_message\", message, playerId: this.localPlayerId, time: new Date()})\n    }\n\n    getLocalPlayer() {\n        return this.state.players[this.localPlayerId]\n    }\n}\n\nexport default Playground","export default class Const {\n    static PLAYER_MODE_CREATE = \"create\"\n    static PLAYER_MODE_EDIT = \"edit\"\n    static PLAYER_MODE_DRAG = \"drag\"\n    static PLAYER_MODE_OBJECT = \"object\"\n}","class MeshEvents {\n    static MOUSE_MOVE = 'mouse_move'\n    static CLICK = 'click'\n    static POINTER_OUT = 'pointer_out'\n    static eventMaps = {}\n\n    static listenFor(id, eventsToHandlers, includedMeshes) {\n\n        eventsToHandlers.includedMeshes = includedMeshes\n        MeshEvents.eventMaps[id] = eventsToHandlers\n    }\n\n    static removeListener(id) {\n        delete MeshEvents.eventMaps[id]\n    }\n\n    static eventOccurred(type, event) {\n        Object.values(MeshEvents.eventMaps).forEach(handlerMap => {\n            const meshQualifies = !handlerMap.includedMeshes || handlerMap.includedMeshes.includes(event.object.id)\n            if (meshQualifies && handlerMap[type]) {\n                 handlerMap[type](event)\n            }\n        })\n    }\n}\n\nexport default MeshEvents","import { MD2CharacterComplex } from 'three/examples/jsm/misc/MD2CharacterComplex.js';\nimport { MathUtils, Vector3 } from 'three'\nimport Util from './Util'\n\nconst WEAPONS_ENABLED = true\nconst MD2_SCALE = 1\nconst MD2_CONTROLS = {\n    moveForward: false,\n    moveBackward: false,\n    moveLeft: false,\n    moveRight: false,\n    moveUp: false,\n    moveDown: false,\n    crouch: false,\n    jump: false,\n    attack: false\n}\n\nclass ModelFactory {\n    static base\n    static skinCount\n    static instanceIndex = 2\n\n    static init() {\n        \n\n        const configOgro = {\n\n            baseUrl: \"models/ogro/\",\n\n            body: \"ogro.md2\",\n            skins: [\"grok.jpg\", \"ogrobase.png\", \"arboshak.png\", \"ctf_r.png\", \"ctf_b.png\", \"darkam.png\", \"freedom.png\",\n                \"gib.png\", \"gordogh.png\", \"igdosh.png\", \"khorne.png\", \"nabogro.png\",\n                \"sharokh.png\"],\n            weapons: [[\"weapon.md2\", \"weapon.jpg\"]],\n            animations: {\n                move: \"run\",\n                idle: \"stand\",\n                jump: \"jump\",\n                attack: \"attack\",\n                crouchMove: \"cwalk\",\n                crouchIdle: \"cstand\",\n                crouchAttach: \"crattack\"\n            },\n\n            walkSpeed: 1000,\n            crouchSpeed: 175\n        }\n\n        this.skinCount = configOgro.skins.length\n\n        this.base = new MD2CharacterComplex()\n        this.base.scale = MD2_SCALE;\n        this.basePromise = new Promise((resolve, reject) => {\n            this.base.onLoadComplete = () => {\n                this.base.enableShadows(true)\n                this.base.setSkin(2);\n                resolve(this.base)\n            }\n        })\n        this.base.loadParts(configOgro);\n    }\n\n    static customizeMovement(instance) {\n\n        // We use this to override a function defined\n        // on MD2CharacterComplex\n        const customUpdateMovementModel = self => {\n            return delta => {\n                var controls = self.controls;\n                self.decceleration = 1500\n                self.maxSpeed = self.walkSpeed\n\n                if (!self.moveDirection)\n                    self.moveDirection = new Vector3()\n\n                const moveForward = controls.moveForward ? 1 : 0\n                const moveBackward = controls.moveBackward ? -1 : 0\n                const moveRight = controls.moveRight ? -1 : 0\n                const moveLeft = controls.moveLeft ? 1 : 0\n                const moveUp = controls.moveUp ? 1 : 0\n                const moveDown = controls.moveDown ? -1 : 0\n\n                self.impulseDirection = new Vector3(moveRight + moveLeft, moveUp + moveDown, moveForward + moveBackward)\n                self.impulseDirection.normalize()\n\n                // Rotate toward 'target' (where ray cast from cursor hits scene object)\n                const forwardVec = new Vector3(0, 0, 1).applyAxisAngle(new Vector3(0, 1, 0), self.bodyOrientation)\n                const target = new Vector3(self.target.x, self.target.y, self.target.z)\n                const toTarget = target.clone().sub(self.root.position).normalize()\n                toTarget.y = 0\n                const rotationGap = forwardVec.cross(toTarget).y\n                self.bodyOrientation += rotationGap * delta * 10\n\n                self.impulseDirection.applyAxisAngle(new Vector3(0, 1, 0), self.bodyOrientation)\n\n                if (self.impulseDirection.length() > 0) {\n                    self.moveDirection.copy(self.impulseDirection)\n                }\n\n                // Animate while turning\n                if (Math.abs(rotationGap) > 0.2) {\n                    self.speed = rotationGap * delta * 10\n                    if (rotationGap < 0)\n                        controls.moveLeft = true\n                    else\n                        controls.moveRight = true\n                }\n\n\n                if (self.impulseDirection.length() > 0) {\n                    self.speed = self.maxSpeed // We don't bother accelerating--jump to max speed\n                } else {\n                    const k = Util.exponentialEaseOut(self.speed / self.maxSpeed);\n                    self.speed = MathUtils.clamp(self.speed - k * delta * self.decceleration, 0, self.maxSpeed);\n                }\n\n                // displacement\n                const deltaVec = self.moveDirection.clone().multiplyScalar(self.speed * delta / 10)\n                self.root.position.add(deltaVec)\n\n                self.root.rotation.y = self.bodyOrientation;\n            }\n        }\n\n        instance.updateMovementModel = customUpdateMovementModel(instance)\n    }\n\n    static async getModelInstance(skin = this.instanceIndex) {\n        this.instanceIndex = (this.instanceIndex + 1) % this.skinCount\n\n        const instance = new MD2CharacterComplex()\n        instance.scale = MD2_SCALE\n        instance.controls = this.getControlsCopy()\n        instance.id = Math.random()\n        this.customizeMovement(instance)\n\n        return await this.basePromise.then(base => {\n            instance.shareParts(base)\n            instance.enableShadows(true);\n            instance.setSkin(skin)\n            instance.target = new Vector3()\n\n            if (WEAPONS_ENABLED)\n                instance.setWeapon(0)\n\n            return instance\n        })\n    }\n\n    static getControlsCopy() {\n        const controls = {}\n        Object.keys(MD2_CONTROLS).forEach(key => controls[key] = MD2_CONTROLS[key])\n        return controls\n    }\n}\n\nModelFactory.init()\n\nexport default ModelFactory","import React, { useEffect, useMemo, useState } from 'react'\nimport * as THREE from 'three'\nimport { Line2 } from 'three/examples/jsm/lines/Line2.js';\nimport { LineMaterial } from 'three/examples/jsm/lines/LineMaterial.js';\nimport { LineGeometry } from 'three/examples/jsm/lines/LineGeometry.js';\nimport { useFrame, useThree, Dom } from 'react-three-fiber'\nimport { useDOM } from './w-hooks'\nimport ModelFactory from '../ModelFactory'\nimport Util from '../Util'\nimport './Player.css'\nimport { Vector2 } from 'three';\nimport Const from '../constants'\n\n// let imageCapture\n// let texture\n// let outerTick = 0\n\nconst PLAYER_SPEED_SCALE = 1.75\n\nfunction Player({ player, messages, mode }) {\n    const [md2, setMd2] = useState(null)\n    const [height, setHeight] = useState(0)\n    const [laser, setLaser] = useState(null)\n    const { size } = useThree()\n    // const [tick, setTick] = useState(0)\n\n    useDOM(['#player-label-' + player.id], [\"md2-root-\" + player.id])\n\n    useEffect(() => {\n        const label = document.createElement(\"div\")\n        label.id = 'player-label-' + player.id\n        label.innerText = player.name\n        document.getElementsByClassName(\"App\")[0].appendChild(label)\n    }, [])\n\n    useEffect(() => {\n        ModelFactory.getModelInstance(player.skindex).then(instance => {\n            const bbox = Util.computeCompositeBoundingBox(instance.root)\n\n            instance.root.userData.name = \"md2-root-\"+player.id\n\n            setHeight(bbox.getSize().y)\n            setMd2(instance)\n\n            instance.root.position.set(player.position.x, instance.root.position.y, player.position.z)\n\n            const geometry = new LineGeometry();\n            geometry.setPositions([0, 0, 0, 0, 0, 100])\n\n            const lineProps = linePropsForMode(mode)\n            const matLine = new LineMaterial({\n                color: lineProps.color,\n                linewidth: lineProps.size,\n                vertexColors: false,\n                dashed: false,\n                resolution: new Vector2(size.width, size.height)\n            });\n\n            const line = new Line2(geometry, matLine)\n            instance.root.add(line)\n\n            setLaser(line)\n        })\n    }, [mode])\n\n    // useEffect(() => {\n    //     setInterval(() => {\n    //         setTick(++outerTick)\n    //     }, 400)\n    // }, [])\n\n    // const vidTex = useMemo(() => {\n    //     return getVideoTexture()\n    // }, [tick])\n\n    useFrame((info, delta) => {\n        if (md2) {\n            md2.controls.moveForward = player.keyStates['w'] || player.keyStates['ArrowUp']\n            md2.controls.moveBackward = player.keyStates['s'] || player.keyStates['ArrowDown']\n            md2.controls.moveLeft = player.keyStates['a'] || player.keyStates['ArrowLeft']\n            md2.controls.moveRight = player.keyStates['d'] || player.keyStates['ArrowRight']\n            md2.controls.moveUp = player.keyStates['q']\n            md2.controls.moveDown = player.keyStates['e']\n            md2.controls.jump = player.keyStates[' ']\n            md2.controls.attack = player.keyStates['f']\n            md2.update(delta * PLAYER_SPEED_SCALE)\n            player.position.x = md2.root.position.x\n            player.position.y = md2.root.position.y\n            player.position.z = md2.root.position.z\n\n            md2.target = player.target\n            const pos = new THREE.Vector3(player.position.x, player.position.y, player.position.z)\n            const tar = new THREE.Vector3(md2.target.x, md2.target.y, md2.target.z)\n\n            tar.sub(pos)\n\n            laser.rotation.y = -md2.bodyOrientation\n            laser.geometry.setPositions([0, 20, 5, tar.x, tar.y, tar.z])\n            laser.geometry.needsUpdate = true\n        }\n    })\n\n    return (\n        <mesh>\n            {md2 && \n                <>\n                    <primitive object={md2.root} onClick={e => console.log('click')}>\n                        {/* <mesh position={[0, 200, -100]}>\n                            <planeBufferGeometry attach=\"geometry\" args={[250, 150]} />\n                            <meshBasicMaterial attach=\"material\" side={THREE.DoubleSide}>\n                                <primitive attach=\"map\" object={vidTex} wrapS={THREE.ClampToEdgeWrapping} wrapT={THREE.ClampToEdgeWrapping} encoding={THREE.sRGBEncoding}/>\n                            </meshBasicMaterial>\n                        </mesh> */}\n                    </primitive>\n\n                    {messages.map((message, i) => (\n                        <Dom key={message.time} center position={[player.position.x, player.position.y + height/1.5, player.position.z]}>\n                            <div style={{transform: `translateY(${-i*2.1}rem)`}} className=\"speech-bubble\">{message.message}</div>\n                        </Dom>\n                    ))}\n                </>\n            }\n        </mesh>\n    )\n}\n\nfunction linePropsForMode(mode) {\n    switch (mode) {\n        case Const.PLAYER_MODE_CREATE:\n            return { color: 0x66ff11, size: 2}\n        case Const.PLAYER_MODE_EDIT:\n            return { color: 0x0033dd, size: 2 }\n        case Const.PLAYER_MODE_DRAG:\n            return { color: 0x11ff66, size: 7 }\n        case Const.PLAYER_MODE_OBJECT:\n            return { color: 0x882288, size: 2 }\n        default:\n            console.error(\"unrecognized player mode\", mode)\n            break;\n    }\n}\n\n// function getVideoTexture() {\n//     if (!texture)\n//         texture = new THREE.Texture()\n\n//     var video = document.getElementById('video');\n\n//     const drawCanvas = img => {\n//         const canvas = document.getElementById('test-canvas');\n//         canvas.width = getComputedStyle(canvas).width.split('px')[0];\n//         canvas.height = getComputedStyle(canvas).height.split('px')[0];\n//         let ratio = Math.min(canvas.width / img.width, canvas.height / img.height);\n//         let x = (canvas.width - img.width * ratio) / 2;\n//         let y = (canvas.height - img.height * ratio) / 2;\n//         canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);\n//         canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height,\n//             x, y, img.width * ratio, img.height * ratio);\n\n//         canvas.width = 256\n//         canvas.height = 256\n//         canvas.style.width = \"256px\"\n//         canvas.style.height = \"256px\"\n\n//         return canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height)\n//     }\n\n//     const updateTexture = async imageCapture => {\n//         const { imageWidth, imageHeight } = await imageCapture.getPhotoCapabilities();\n//         // console.log(\"asdf\", imageWidth, imageHeight)\n\n//         imageCapture.takePhoto({imageWidth: imageWidth.min, imageHeight: imageHeight.min})\n//             .then(blob => createImageBitmap(blob))\n//             .then(imageBitmap => {\n//                 texture.image = drawCanvas(imageBitmap)\n//                 texture.format = THREE.RGBAFormat\n//                 texture.needsUpdate = true\n//             })\n//             .catch(error => console.log(error));\n//     }\n\n//     if (!imageCapture) {\n//         navigator.mediaDevices.getUserMedia({ video: true, audio: false })\n//             .then(mediaStream => {\n//                 video.srcObject = mediaStream;\n\n//                 const track = mediaStream.getVideoTracks()[0];\n//                 imageCapture = new ImageCapture(track);\n\n//                 return imageCapture\n//             }).then(imageCapture => {\n//                 updateTexture(imageCapture)\n//             }).catch(error => console.log('Error with video stream capture', error.name || error))\n//     } else {\n\n//         updateTexture(imageCapture)\n//     }\n\n//     return texture\n// }\n\nexport default Player","import React, { useEffect, useState } from 'react'\nimport {useThree, useFrame} from 'react-three-fiber'\nimport Util from '../Util'\nimport { Vector3 } from 'three'\n\nfunction useDOM(domSelectors, sceneNames) {\n    const {scene, size, camera} = useThree()\n    const [nodeMap, setNodeMap] = useState(null)\n\n    useFrame(() => {\n\n        const domNodes = domSelectors.map(s => document.querySelector(s))\n        const sceneNodes = []\n\n        sceneNames.forEach(nodeName => {\n            scene.traverse(node => {\n                if (node.userData.name === nodeName) {\n                    sceneNodes.push(node)\n                }\n            })\n        })\n\n        if (domNodes.length === sceneNodes.length) {\n            domNodes.forEach((dNode, i) => {\n                const sNode = sceneNodes[i]\n                \n                const worldPoint = new Vector3()\n                sNode.getWorldPosition(worldPoint)\n\n                const screenPoint = Util.vec3ToScreenPoint(worldPoint, camera, size.width, size.height)\n\n                dNode.style.position = \"absolute\"\n                dNode.style.zIndex = \"10000\"\n                dNode.style.transform = \"translateX(-50%)\"\n\n                dNode.style.left = screenPoint.x + \"px\"\n                dNode.style.top = screenPoint.y + \"px\"\n            })\n        }\n    })\n}\n\nexport {useDOM}","import React, {useState, useEffect} from 'react'\nimport { Vector3 } from 'three'\nimport { extend, useThree, useUpdate } from \"react-three-fiber\"\nimport { Line2 } from 'three/examples/jsm/lines/Line2.js'\nimport { LineMaterial } from 'three/examples/jsm/lines/LineMaterial.js'\nimport { LineGeometry } from 'three/examples/jsm/lines/LineGeometry.js'\nimport MeshEvents from '../MeshEvents'\nimport Util from '../Util'\n\nextend({ LineMaterial, LineGeometry, Line2 })\n\nconst MAX_POLY_POINTS = 50\nconst SNAP_RADIUS = 30\n\nfunction PartialStructure({player, finishStructureFunc}) {\n    const [points, setPoints] = useState([])\n    const [cursorPoint, setCursorPoint] = useState(null)\n    const [inSnapRange, setInSnapRange] = useState(false)\n    const { size } = useThree()\n\n    useEffect(() => {\n        const handleMeshMouseMove = e => {\n            if (points.length > 0) {\n                const vec = new Vector3(e.point.x, e.point.y+0.1, e.point.z)\n                setCursorPoint(vec)\n            }\n        }\n\n        const handleMeshClick = e => {\n            const vec = new Vector3(e.point.x, e.point.y, e.point.z)\n\n            let finish = false\n            if (points.length > 2) {\n                const snapDiffVec = vec.clone().sub(points[0])\n                if (snapDiffVec.length() < 20) {\n                    vec.add(snapDiffVec)\n                    finish = true\n                }\n            }\n\n            vec.y += 0.1\n\n            setPoints([...points, vec])\n\n            if (finish) {\n                const rotation = e.object.rotation.clone()\n                rotation.x *= -1\n                rotation.y *= -1\n                rotation.z *= -1\n\n                const normal = e.face.normal.clone().applyEuler(rotation)\n                const centroid = Util.centroid(points)\n                const extrusionLine = {start: centroid, end: centroid.clone().addScaledVector(normal, 10)}\n                const structure = { id: Util.generateId(), points, extrusionLine }\n\n                finishStructureFunc(structure)\n                setPoints([])\n                setInSnapRange(false)\n                setCursorPoint(null)\n            }\n        }\n\n        MeshEvents.listenFor(\"partial_structure\", {\n            [MeshEvents.MOUSE_MOVE]: handleMeshMouseMove,\n            [MeshEvents.CLICK]: handleMeshClick,\n        })\n\n        return () => {\n            MeshEvents.removeListener(\"partial_structure\")\n        }\n\n    }, [points])\n\n    const ref = useUpdate(geom => {\n        if (points.length < 1 || cursorPoint === null) {\n            geom.setPositions(new Float32Array(MAX_POLY_POINTS*3))\n            return\n        }\n\n        const modCursorPoint = cursorPoint.clone()\n        if (points.length > 2) {\n            const snapDiffVec = points[0].clone().sub(cursorPoint)\n\n            // within snap radius\n            if (snapDiffVec.length() < SNAP_RADIUS) {\n                modCursorPoint.add(snapDiffVec)\n                setInSnapRange(true)\n            } else {\n                setInSnapRange(false)\n            }\n\n            // Check if first and last points overlap\n            if (points[0].clone().sub(points[points.length - 1]).length() < 0.1) {\n                finishStructureFunc(points)\n                setPoints([])\n                setInSnapRange(false)\n                setCursorPoint(null)\n            }\n        }\n            \n        const finalPoints = points.reduce((acc, { x, y, z }) => [...acc, x, y, z], [], [])\n        finalPoints.push(modCursorPoint.x, modCursorPoint.y, modCursorPoint.z)\n\n        // The number of points must always be exactly the same,\n        // so will fill the end with the last point added repeatedly\n        while (finalPoints.length < MAX_POLY_POINTS*3) {\n            finalPoints.push(finalPoints[finalPoints.length - 3], finalPoints[finalPoints.length - 2], finalPoints[finalPoints.length - 1])\n        }\n\n        finalPoints.length = Math.min(MAX_POLY_POINTS*3, finalPoints.length)\n\n        geom.setPositions(finalPoints)\n    }, [points, cursorPoint])\n\n    return  (\n        <>\n            <line2>\n                <lineGeometry attach=\"geometry\" ref={ref} />\n                <lineMaterial attach=\"material\" color={0x66ff11} linewidth={10} resolution={[size.width, size.height]} />\n            </line2>\n\n            {points.map((point, i) => (\n                <mesh key={point.x+point.y+point.z+\"\"} castShadow position={[point.x, point.y, point.z]}>\n                    <sphereGeometry attach=\"geometry\" args={[(i === 0 && inSnapRange) ? SNAP_RADIUS : 7, 32, 32]} />\n                    <meshPhysicalMaterial attach=\"material\" color={(i === 0 && inSnapRange) ? 0x00ff00 : 0x117700} clearcoat metalness={0.25} clearcoatRoughness={0.75} roughness={0.1}/>\n                </mesh>\n            ))}\n        </>\n    )\n}\n\nexport default PartialStructure","import React, { useState, useEffect, useRef } from 'react'\nimport { Shape, Vector2, Vector3 } from 'three'\nimport { useUpdate, useFrame } from 'react-three-fiber'\nimport MeshEvents from '../MeshEvents'\nimport Const from '../constants'\n\nconst INITIAL_EXTRUSION_DEPTH = 4\n\nfunction Structure({points, extrusionLine, player, onPointerMove, onClick, onPointerOut, id, playerMode, setPlayerMode}) {\n    const [baseShape, setBaseShape] = useState(null)\n    const [extrudeSettings, setExtrudeSettings] = useState({steps: 1, depth: INITIAL_EXTRUSION_DEPTH, bevelThickness: 3, bevelSize: 4, bevelSegments: 4})\n    const [overMainFace, setOverMainFace] = useState(false)\n    const [dragStartPoint, setDragStartPoint] = useState(null)\n    const [showDragIndicator, setShowDragIndicator] = useState(false)\n    const meshRef = useRef()\n\n    useEffect(() => {\n        setBaseShape(new Shape(points.map(p => new Vector2(p.x, p.z))))\n    }, [points, extrusionLine])\n\n    useFrame(() => {\n        if (playerMode === Const.PLAYER_MODE_DRAG && dragStartPoint !== null) {\n            const dragLine = new Vector3().copy(player.position).sub(dragStartPoint)\n            const normal = new Vector3(0, 1, 0) // cheat and set to Y for now\n            const projectedDragLine = normal.clone().multiplyScalar(normal.dot(dragLine))\n\n            const newDepth = projectedDragLine.length() + INITIAL_EXTRUSION_DEPTH\n            setExtrudeSettings({...extrudeSettings, depth: newDepth})\n        }\n    })\n\n    useEffect(() => {\n        const handleMeshMouseMove = e => {\n            // faces have three verts a, b, c.\n            // We use the first arbitrarily\n            const hoverFaceIndex = e.face.a\n\n            if (hoverFaceIndex >= 0 && hoverFaceIndex <= mainPolyVertexCount(points.length)) {\n                setOverMainFace(true)\n            } else {\n                setOverMainFace(false)\n            }\n        }\n        const handlePointerOut = e => {\n            setOverMainFace(false)\n        }\n\n        const handleMeshClick = e => {\n            if (playerMode === Const.PLAYER_MODE_EDIT && overMainFace) {\n                setPlayerMode(Const.PLAYER_MODE_DRAG)\n                setDragStartPoint(new Vector3().copy(player.position))\n            } else if (playerMode === Const.PLAYER_MODE_DRAG) {\n                setPlayerMode(Const.PLAYER_MODE_EDIT)\n                setDragStartPoint(null)\n                setOverMainFace(false)\n            }\n        }\n\n        if (meshRef.current) {\n            MeshEvents.listenFor(\"structure_\" + id, {\n                [MeshEvents.MOUSE_MOVE]: handleMeshMouseMove,\n                [MeshEvents.CLICK]: handleMeshClick,\n                [MeshEvents.POINTER_OUT]: handlePointerOut\n            }, [meshRef.current.id])\n        }\n    }, [meshRef.current, overMainFace, playerMode, id, setPlayerMode])\n\n    return (\n        <>\n            {baseShape &&\n                <mesh ref={meshRef} rotation-x={Math.PI/2} position-y={extrudeSettings.depth} castShadow receiveShadow onPointerMove={onPointerMove} onClick={onClick} onPointerOut={onPointerOut}>\n                    <extrudeBufferGeometry attach=\"geometry\" args={[baseShape, extrudeSettings]} />\n                    {/* <meshPhysicalMaterial attachArray=\"material\" color={0x33ff33} metalness={0.9} roughness={0.1} clearcoat clearcoatRoughness={0.25} /> */}\n                    <meshPhysicalMaterial attach=\"material\" color={0xffffff} metalness={0.9} roughness={0} clearcoat clearcoatRoughness={0.25} />\n                </mesh>\n            }\n\n            {baseShape && overMainFace &&\n                <mesh rotation-x={Math.PI / 2} position-y={extrudeSettings.depth + 3.1}>\n                    <extrudeBufferGeometry attach=\"geometry\" args={[baseShape, {depth: 2, bevelSize: 1, bevelThickness: 1, bevelSegments: 2}]} />\n\n                    {playerMode === Const.PLAYER_MODE_EDIT && \n                    <meshPhysicalMaterial attach=\"material\" color={0x0033dd} metalness={0.9} roughness={0.1} clearcoat clearcoatRoughness={0.25} />\n                    }\n                    {playerMode !== Const.PLAYER_MODE_EDIT &&\n                    <meshPhysicalMaterial attach=\"material\" color={0x001133} emissive={0x00ff00} metalness={0.9} roughness={0.1} clearcoat clearcoatRoughness={0.25} />\n                    }\n                </mesh>\n            }\n        </>\n    )\n\n    function mainPolyVertexCount(pointCount) {\n        // This is something I just worked out by observing\n        // different instances of ExtrudeBufferGeometry. It\n        // depends on the internals of ExtrudeBufferGeometry.\n        return (pointCount-2)*6\n    }\n}\n\nexport default Structure","import React, {useState, useRef, useEffect} from 'react'\nimport './ChatWindow.css'\nimport {InputGroup} from '@blueprintjs/core'\n\nfunction ChatWindow({sendChatMessage, messages, hideChat}) {\n    const [inputText, setInputText] = useState(\"\")\n    const allMessagesRef = useRef()\n\n    const handleKeyDown = e => {\n        if (e.which === 13) { //check for 'enter' press\n            sendChatMessage(inputText)\n            setInputText(\"\")\n        } else if (e.which === 27) { //escape key\n            hideChat()\n        }\n    }\n\n    useEffect(() => {\n        allMessagesRef.current.scrollTop = allMessagesRef.current.scrollHeight\n    }, [messages])\n\n    return (\n        <div className=\"ChatWindow\">\n            <div className=\"all-messages\" ref={allMessagesRef}>\n                {messages.map(message => (\n                    <div className=\"chat-message\" key={message.time}>\n                        <div className=\"chat-message-name\">{message.player.name}:</div>\n                        <div className=\"chat-message-content\">{message.message}</div>\n                    </div>\n                ))}\n            </div>\n            <InputGroup\n                className=\"your-message\"\n                placeholder=\"your message...\"\n                large\n                onKeyDown={handleKeyDown}\n                value={inputText}\n                onChange={event => setInputText(event.target.value)}\n                autoFocus\n            />\n        </div>\n    )\n}\n\nexport default ChatWindow","import React, {useMemo, useEffect, useState, useRef} from 'react'\nimport * as THREE from 'three'\nimport Stats from 'three/examples/jsm/libs/stats.module.js'\nimport { Canvas, extend, useThree, useFrame } from 'react-three-fiber'\nimport Playground from './playground'\nimport Const from './constants'\nimport MeshEvents from './MeshEvents'\nimport Player from './components/Player'\nimport PartialStructure from './components/PartialStructure'\nimport Structure from './components/Structure'\nimport ChatWindow from './components/ChatWindow'\nimport { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer'\nimport { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass'\nimport { SSAOPass } from 'three/examples/jsm/postprocessing/SSAOPass'\nimport { UnrealBloomPass } from 'three/examples/jsm/postprocessing/UnrealBloomPass'\nimport './MainCanvas.css'\nimport { Vector3, MathUtils, Vector2 } from 'three'\n\nextend({ EffectComposer, RenderPass, UnrealBloomPass, SSAOPass })\n\nconst stats = new Stats()\nconst camDest = new Vector3(0, 100, 100)\nconst camLookAtDest = new Vector3(0, 0, 0)\nconst lastLookAtVec = new Vector3()\n\nlet camZoom = 1\n\nconst CameraController = ({playground}) => {\n    const { camera } = useThree()\n\n    useFrame(() => {\n        stats.update()\n        const positionObj = playground.getLocalPlayer().position\n        const targetObj = playground.getLocalPlayer().target\n        const position = new Vector3(positionObj.x, positionObj.y, positionObj.z)\n        const shiftedPosition = position.set(position.x, position.y + 70, position.z)\n        const target = new Vector3(targetObj.x, targetObj.y, targetObj.z)\n\n        const toTarget = target.clone().sub(shiftedPosition).normalize()\n        const extension = toTarget.clone().multiplyScalar(-200 * camZoom)\n        extension.z = Math.max(Math.abs(extension.z), 50) * Math.sign(extension.z)\n        extension.y = Math.max(extension.y, 50)\n\n        camDest.copy(position.clone().add(extension))\n\n        camLookAtDest.copy(position)\n\n\n        const scale = MathUtils.clamp(camera.position.clone().sub(camDest).length() / 10, 0.1, 4)\n        camera.position.copy(camera.position.lerp(camDest, 0.005 * scale))\n        \n        const newLookAt = lastLookAtVec.lerp(camLookAtDest, 0.05).clone()\n        camera.lookAt(newLookAt)\n        camera.updateProjectionMatrix()\n\n        lastLookAtVec.copy(newLookAt)\n    })\n\n    return null;\n}\n\nfunction InputHandler({ playground, setChatVisible, chatVisible, setPlayerMode}) {\n    const {gl } = useThree();\n\n    useEffect(() => {\n        gl.domElement.onclick = e => {\n            setChatVisible(false)\n\n            if (playground)\n                playground.localClick(e)\n        }\n        window.onkeydown = e => {\n\n            if (e.key === 't') {\n                if (!chatVisible) {\n                    e.preventDefault()\n                }\n\n                setChatVisible(true)\n            } else if (e.which === 27) { //escape key\n                setChatVisible(!chatVisible)\n\n            } else if (e.key === 'j') {\n                setPlayerMode(Const.PLAYER_MODE_CREATE)\n            } else if (e.key === 'k') {\n                setPlayerMode(Const.PLAYER_MODE_EDIT)\n            } else if (e.key === 'l') {\n                setPlayerMode(Const.PLAYER_MODE_OBJECT)\n            }\n\n            if (playground && !chatVisible)\n                playground.localKeyDown(e)\n        }\n        window.onkeyup = e => {\n            if (playground)\n                playground.localKeyUp(e)\n        }\n        gl.domElement.onmousemove = e => {\n            if (playground)\n                playground.localMouseMove(e)\n        }\n\n        gl.domElement.onwheel = event => {\n            event.preventDefault();\n            camZoom += event.deltaY * 0.01;\n            camZoom = Math.min(Math.max(.05, camZoom), 3);\n        }\n    }, [gl, playground, chatVisible])\n\n    return null\n}\n\nfunction Effects({ssao, bloom}) {\n    const { gl, scene, camera, size } = useThree()\n    const composer = useRef()\n    useEffect(() => void composer.current.setSize(size.width, size.height), [size])\n    useFrame(() => composer.current.render(), 1)\n    return (\n        <effectComposer ref={composer} args={[gl]}>\n            <renderPass attachArray=\"passes\" args={[scene, camera]} />\n            {bloom && \n                <unrealBloomPass\n                    attachArray=\"passes\"\n                    args={[undefined, 1.5, 0.4, 0.60]}\n                    bloomThreshold={1}\n                    bloomStrength={1}\n                    bloomRadius={0}\n                />\n            }\n            {ssao &&\n                <sSAOPass\n                    attachArray=\"passes\"\n                    args={[scene, camera, size.width, size.height]}\n                    kernelRadius={16}\n                    minDistance={0.005}\n                    maxDistance={50}\n                />\n            }\n        </effectComposer>\n    )\n}\n\nfunction MainCanvas({player}) {\n    const [players, setPlayers] = useState([])\n    const [messages, setMessages] = useState([])\n    const [playground, setPlayground] = useState(null)\n    const [chatVisible, setChatVisible] = useState(false)\n    const [structures, setStructures] = useState([])\n    const grassTexture = useMemo(() => new THREE.TextureLoader().load(\"rust2.jpg\"), [])\n    const [playerMode, setPlayerMode] = useState(Const.PLAYER_MODE_CREATE)\n\n    useEffect(() => {\n        setPlayground(new Playground(player, players => setPlayers(players), messages => setMessages(messages)))\n    }, [player])\n\n    const handleMeshMouseMove = e => {\n        playground.getLocalPlayer().target = e.point\n        player.target = e.point\n        MeshEvents.eventOccurred(MeshEvents.MOUSE_MOVE, e)\n    }\n    const handleMeshClick = e => {\n        MeshEvents.eventOccurred(MeshEvents.CLICK, e)\n    }\n    const handleMeshPointerOut = e => {\n        MeshEvents.eventOccurred(MeshEvents.POINTER_OUT, e)\n    }\n\n    const finishStructure = structure => {\n        setStructures([...structures, structure])\n        setPlayerMode(Const.PLAYER_MODE_EDIT)\n    }\n\n    useEffect(() => {\n        console.log(\"MODE: \", playerMode)\n    }, [playerMode])\n\n    return (\n        <div className=\"main-canvas-container\">\n            <Canvas\n                style={{ backgroundColor: \"#789\" }}\n                gl={{ antialias: false, alpha: false}}\n                pixelRatio={window.devicePixelRatio}\n                camera={{ position: [0, 10, 10], near: 1, far: 4000 }}\n                shadowMap\n                onCreated={({ gl }) => {\n                    gl.toneMapping = THREE.Uncharted2ToneMapping\n                    gl.outputEncoding = THREE.sRGBEncoding\n                    gl.shadowMap.type = THREE.PCFSoftShadowMap\n                    gl.setClearColor(new THREE.Color(\"#667788\"))\n                }}\n            >\n                <Effects />\n\n                <CameraController playground={playground} />\n                <InputHandler playground={playground} setChatVisible={setChatVisible} chatVisible={chatVisible} setPlayerMode={setPlayerMode} />\n\n                <fog attach=\"fog\" args={[0x667788, 500, 1500]} />\n                <ambientLight args={[0x666666]} />\n                <directionalLight\n                    args={[0xffffff, 7]}\n                    position={[0, 6000, 3000]}\n                    shadow-camera-left={-1000}\n                    shadow-camera-bottom={-1000}\n                    shadow-camera-right={1000}\n                    shadow-camera-top={1000}\n                    shadow-camera-near={1}\n                    shadow-camera-far={12000}\n                    shadow-mapSize-width={1024}\n                    shadow-mapSize-height={1024}\n                    castShadow\n                />\n\n                {players.map(player => <Player key={player.id} player={player} mode={playerMode} messages={player.visibleMessages} />)}\n\n                {playerMode === Const.PLAYER_MODE_CREATE &&\n                    <PartialStructure player={player} finishStructureFunc={finishStructure} />\n                }\n\n                {structures.map(structure => <Structure \n                                                key={structure.id}\n                                                id={structure.id}\n                                                points={structure.points}\n                                                extrusionLine={structure.extrusionLine}\n                                                player={playground.getLocalPlayer()}\n                                                onPointerMove={handleMeshMouseMove}\n                                                onClick={handleMeshClick}\n                                                onPointerOut={handleMeshPointerOut}\n                                                playerMode={playerMode}\n                                                setPlayerMode={setPlayerMode}\n                                            />)}\n\n                <mesh receiveShadow \n                    rotation-x={- Math.PI / 2} \n                    onPointerMove={handleMeshMouseMove}\n                    onClick={handleMeshClick}\n                >\n                    <planeBufferGeometry attach=\"geometry\" args={[16000, 16000]} />\n                    <meshStandardMaterial attach=\"material\" color={0x333333} roughness={0.55} metalness={0.8}>\n                        <primitive attach=\"map\" object={grassTexture} repeat={[64, 64]} wrapS={THREE.RepeatWrapping} wrapT={THREE.RepeatWrapping} encoding={THREE.sRGBEncoding}/>\n                    </meshStandardMaterial>\n                </mesh>\n            </Canvas>\n            {playground && chatVisible &&\n                <ChatWindow sendChatMessage={playground.sendChatMessage.bind(playground)} messages={messages} hideChat={() => setChatVisible(false)}/>\n            }\n        </div>\n    )\n}\n\nexport default MainCanvas","import React, {useState} from 'react';\nimport './LoginPrompt.css'\nimport {FormGroup, InputGroup, Button} from '@blueprintjs/core'\nimport Player from '../PlayerData'\n\nfunction LoginPrompt({logIn}) {\n    const [name, setName] = useState(\"\")\n\n    const handleTextChange = e => {\n        const text = e.target.value || \"\"\n        setName(text)\n    }\n\n    const handleKeyPress = e => e.which === 13 ? logIn(Player.create(name)) : \"\"\n\n    return (\n        <div className=\"login-container bp3-light\">\n            <FormGroup\n                label=\"Choose a name to use:\"\n            >\n                <InputGroup autoFocus placeholder=\"name...\" large onChange={handleTextChange} onKeyDown={handleKeyPress}/>\n            </FormGroup>\n\n            <Button onClick={() => {\n                logIn(Player.create(name))\n            }}>Join</Button>\n        </div>\n    )\n}\n\nexport default LoginPrompt","import React, {useState, useEffect} from 'react';\nimport MainCanvas from './MainCanvas'\nimport LoginPrompt from './components/LoginPrompt'\nimport Player from './PlayerData'\nimport './App.css';\n\nconst QUICK_START = false\n\nfunction App() {\n  const [loggedIn, setLoggedIn] = useState(false)\n  const [player, setPlayer] = useState(null)\n\n  const doLogin = (player) => {\n        setPlayer(player)\n        setLoggedIn(true)\n  }\n\n  useEffect(() => {\n      if (QUICK_START)\n          doLogin(Player.create())\n  }, [])\n\n  return (\n    <div className=\"App bp3-dark\">\n\n        {player &&\n          <MainCanvas player={player}/>\n        }\n\n        <div className=\"screen-container\">\n              {!loggedIn &&\n                  <LoginPrompt logIn={doLogin} />\n              }\n        </div>\n      \n      {/* This is for webcam capture/display stuff */}\n      {/* <canvas id=\"test-canvas\"></canvas>\n      <video id=\"video\" style={{ visibility: \"hidden\"}}></video> */}\n    </div>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\nexport function register(config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl, config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl, config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}